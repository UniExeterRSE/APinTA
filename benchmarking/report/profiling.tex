\documentclass[a4paper,titlepage]{article}
\usepackage{hyperref}
\usepackage{dingbat}
\usepackage{fancyhdr}
\usepackage{geometry}
\geometry{left=3.0truecm,right=3.0truecm,top=3.0truecm,bottom=3.0truecm} 

\author{David Acreman}
\title{Profiling Firedrake}

\begin{document}
\pagestyle{fancy}
\lhead{}
\chead{}
\rhead{Profiling report}

\maketitle
\pagebreak
\tableofcontents
\pagebreak

\section{Introduction}

This document will become the profiling report deliverable. Profiling is deliverable 5.1.1 and builds are deliverable 5.1.2.
This report primarily focusses on Firedrake but the profiling tools evaluated could be used for profiling other codes used by the project.

\section{Target platforms}

The target HPC platforms for the project are Archer-2 (national tier-1), Isambard (national tier-2) and Isca (local tier-3). Isambard has two separate systems based on the ARM64 architecture: the XCI system which is an established production system, and the A64FX system which is a newer system. The A64FX system should be considered a stretch objective as the hardware and software are less well known to us. We have also purchased a local server which is designed to be similar to an Archer compute node, although it will run Ubuntu which will make it easier to build Firedrake. The server is in some sense a reference installation as it should use an unmodified Firedrake install script. Installations on other platforms will use non-standard components (e.g. MPI and maths libraries). An overview of the hardware in the target platforms is shown in Table~\ref{tab:hardware}.
%
\begin{table}[htp]
\begin{center}
\begin{tabular}{|l|l|r|r|l|}
\hline 
System         & Processor        & Cores/node & Memory/node     & Interconnect \\
\hline
Archer-2       & AMD x86\_64         & 128        & 256 GB DRAM  & HPE Cray Slingshot  \\
Isambard XCI   & Thunder X2 ARM64    &  64        & 256 GB DRAM  & Cray Aries          \\
Isambard A64FX & Fujitsu A64FX ARM64 & 48         & 32 GB HBM    & Mellanox Infiniband \\
Isca           & Intel x86\_64       & 16/20      & 128 GB DRAM  & Mellanox Infiniband \\
Server         & AMD x86\_64         & 128        & 256 GB DRAM  & None                \\
\hline
\end{tabular}
\end{center}
\caption{Target platform hardware specifications. The Isambard A64FX platform has high bandwidth memory (HBM) which should give better performance than DRAM but has a smaller capacity.}
\label{tab:hardware}
\end{table}%

An overview of the software stacks on the target platforms is shown in Table~\ref{tab:software}. 
The common factor in the compilers is the GNU compiler which is available on all platforms. Each HPC platform has a compiler from the processor vendor (AMD, Intel, ARM and Fujitsu) and Cray systems also have the Cray compiler.
\begin{table}[htp]
\begin{center}
\begin{tabular}{|l|l|l|l|l|}
\hline 
System         & Compilers               & MPI libraries  & Maths libraries & Profilers            \\
\hline
Archer-2       & Cray, GNU, AOCC         & Cray MPICH2     & Cray libsci     & Cray PAT             \\
Isambard XCI   & Cray, GNU, ARM          & Cray MPICH2     & Cray libsci     & Cray PAT, ARM Forge  \\
Isambard A64FX & Cray, GNU, ARM, Fujitsu & Cray MVAPICH2   & Cray libsci     & ARM Forge            \\
Isca           & GNU                     & OpenMPI         & OpenBLAS        & None                  \\
Isca           & Intel                   & Intel           & Intel MKL       & Intel Parallel Studio \\
Server         & GNU                     & MPICH?          & ???             & None                  \\
\hline
\end{tabular}
\end{center}
\caption{Software stacks on target platforms. AOCC is the AMD Optimizing Compiler Collection. Intel MPI and MVAPICH are MPICH derivatives which support an Infiniband interconnect.
The A64FX system did not appear to have a perftools module.}
\label{tab:software}
\end{table}
On the Isambard A64FX system some modules are only available after running 
\begin{verbatim}
module use /lustre/software/aarch64/modulefiles
\end{verbatim}

On the Cray systems compilation is handled by wrapper scripts from the Cray Programming Environment. The wrapper script can run different compilers depending on which programming environment module is loaded at compile time (e.g. \texttt{PrgEnv-cray} calls the Cray compiler and \texttt{PrgEnv-gnu} calls the GNU compiler). The MPI library and maths library are then linked by the wrapper script. On Cray systems the standard profiling tool is Cray Performance Analysis Tools (PAT). On ARM-based Cray systems there is also the ARM/Allinea Forge profiler.

The software environment on Isca is managed using Easybuild which has the concept of a toolchain. There are two toolchains on Isca: the GCC-foss toolchain and the Intel toolchain. Each toolchain has a different MPI library and maths library. Intel Parallel Studio has an MPI profiling tool called Intel Trace Analyzer and Collector (ITAC) which needs to use Intel MPI. \\

\noindent
\textbf{Recommendation: standardise on the GNU compilers for all platforms. This avoids having to manage too many different builds and takes the compiler out of the performance equation (different GCC versions notwithstanding).}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Profiling tools}

Within Firedrake and available on all platforms:
\begin{itemize}
\item PyOP2 timed stage
\item PETSc profiling
\end{itemize}
External profilers:
\begin{itemize}
\item ARM/Allinea Forge
\item Cray PAT
\item Intel Parallel Studio
\end{itemize}
%
Plan for testing external profilers:
\begin{enumerate}
\item Test with a simple example e.g. Mandelbrot
\item Test with Python
\end{enumerate}

\textbf{What to test? Could look at whether the profiler can spot load imbalance vs. overhead and identify the MPI call responsible.}

\textbf{We could get an evaluation licence for ARM Forge and/or Intel Parallel Studio on the server. We could also look at open source profiling software for the server.} \\

\subsection{Cray PAT}

Although this is a Cray tool it does work with compilers other than Cray (the other PrgEnv modules load perftools-base). Experience building SWIFT showed that the \texttt{perftools-lite} module can confuse autogen and configure so only load the module prior to the make command. 

\begin{itemize}
\item Cray PAT has two modes: standard and ``lite''
\item There is a graphical viewer (Apprentice 2) which reads the profiling output
\item Can view a time line from a full trace
\end{itemize}
See also \url{https://docs.nersc.gov/tools/performance/craypat/}.

It's not clear how to use Cray PAT with python/Firedrake. Loading the perftools-lite module and using the python from the cray-python module does not produce any profiling output.
\textbf{Is there a limit on the number of MPI processes? If so I've not seen it.}

\subsection{ARM Forge}

ARM MAP is the profiler which is part of the ARM Forge suite and it can profile C++, C, Fortran and Python\footnote{\url{https://www.arm.com/products/development-tools/server-and-hpc/forge/map}}.
\textbf{Is there a limit to how many MPI processes can be used?}

\subsection{Intel Parallel Studio}

Previously working on Isca with the Intel build. Intel MPI is required for the Trace Analyzer and Collector profiler to work.
\textbf{Is there a limit on the number of MPI processes? If so I've not seen it.}

\subsection{Profilers summary}

\begin{table}[htp]

\begin{center}
\begin{tabular}{|c|c|c|c|c|}
\hline
Profiler              &  Max MPI procs  &  C/C++      & Fortran & Python \\
\hline
Cray PAT              &   ??            & \checkmark  &  ??     &  ??    \\
ARM Forge             &   ??            &    ??       &  ??     &  ??    \\
Intel Parallel Studio &   ??            &    ??       &  ??     &  ??    \\
\hline
\end{tabular}
\end{center}
\caption{Summary of profiling tools}
\label{tab:profiler_summary}
\end{table}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Builds}

Plan:
\begin{enumerate}
\item Working builds on main target platforms
\item Optimised builds on main target platforms: use optimised maths libraries but beware threading
\end{enumerate}
%

\begin{table}[htp]
\begin{center}
\begin{tabular}{|l|c|c|}
\hline
Platform       &  Build status     & Profiling status \\
\hline
Archer2        &  ??               & \\
Isambard XCI   &  working build    & \\
Server         &  ??               & \\
Isca           &  ??               & \\
Isambard A64FX &  ??               & \\
\hline
\end{tabular}
\end{center}
\caption{Status of Firedrake builds and profiling for the target platforms}
\label{table:build_status}
\end{table}%

\begin{itemize}
\item Isambard build of Firedrake: what's happening with BLAS/Lapack etc? Scalapack gets built as part of the PETSc build but is also available from \texttt{libsci}
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{document}
